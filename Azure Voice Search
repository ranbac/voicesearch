<?php
/*
 * Plugin Name: Azure Voice Search (Real-time Streaming)
 * Description: V8.9: B·ªè to√†n b·ªô d·∫•u c√¢u. Click outside to close. Auto Mic. Click to Search.
 * Version: 8.9
 * Author: Strong Anchor Tech (Updated by Gemini)
 * Author URI: https://stronganchortech.com
 */

// ===================================================================================
// PH·∫¶N 1: C√ÄI ƒê·∫∂T PLUGIN V√Ä C·∫§U H√åNH AZURE
// ===================================================================================

add_action('admin_menu', function() {
    add_submenu_page('tools.php', 'Azure Speech Settings', 'Azure Speech', 'manage_options', 'azure-speech-settings', function() {
        ?>
        <div class="wrap">
            <h2>Azure Cognitive Services Speech - C√†i ƒë·∫∑t</h2>
            <form method="post" action="options.php">
                <?php
                    settings_fields('azure_speech_settings_group');
                    do_settings_sections('azure_speech_settings_group');
                ?>
                <table class="form-table">
                    <tr valign="top">
                        <th scope="row">Azure Speech Key</th>
                        <td><input type="text" name="azure_speech_key" value="<?php echo esc_attr(get_option('azure_speech_key')); ?>" size="60" /></td>
                    </tr>
                    <tr valign="top">
                        <th scope="row">Azure Speech Region</th>
                        <td><input type="text" name="azure_speech_region" value="<?php echo esc_attr(get_option('azure_speech_region')); ?>" size="20" placeholder="eastus, southeastasia" /></td>
                    </tr>
                </table>
                <?php submit_button(); ?>
            </form>
        </div>
        <?php
    });
});

add_action('admin_init', function() {
    register_setting('azure_speech_settings_group', 'azure_speech_key');
    register_setting('azure_speech_settings_group', 'azure_speech_region');
});

// ===================================================================================
// PH·∫¶N 2: SHORTCODE HI·ªÇN TH·ªä & X·ª¨ L√ù (REMOVE PUNCTUATION)
// ===================================================================================

add_shortcode('voice_search_button', function() {
    $speech_key = get_option('azure_speech_key');
    $speech_region = get_option('azure_speech_region');

    if (!$speech_key || !$speech_region) {
        return '<p style="color:red">Vui l√≤ng c·∫•u h√¨nh Azure Speech Key & Region trong c√†i ƒë·∫∑t.</p>';
    }

    ob_start();
    ?>
    <script src="https://cdn.jsdelivr.net/npm/microsoft-cognitiveservices-speech-sdk@latest/distrib/browser/microsoft.cognitiveservices.speech.sdk.bundle-min.js"></script>

    <style>
        #voice-search-btn { background: none; border: none; cursor: pointer; padding: 5px; }
        #voice-search-btn img { width: 28px; height: 28px; }

        #voice-popup {
            display: none; position: fixed; 
            top: 50% !important; left: 50% !important;
            transform: translate(-50%, -50%) !important;
            background: #f0f0f0 !important; padding: 20px; border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            text-align: center; z-index: 9999; width: 340px;
            border: 1px solid #ccc;
        }
        #voice-popup.active { display: block; }
        #voice-popup h3 { margin-top: 0; font-size: 18px; }

        .lang-container { display: flex; justify-content: center; gap: 14px; margin-bottom: 12px; }
        .lang-btn { border: none; background: none; cursor: pointer; text-align: center; }
        .lang-btn img { width: 48px; height: 32px; border: 2px solid transparent; border-radius: 6px; transition: 0.2s; }
        .lang-btn.active img { border-color: #0073aa; box-shadow: 0 0 6px rgba(0,115,170,0.6); }
        .lang-label { font-size: 12px; margin-top: 4px; color: #333; }
        .lang-note { font-size: 10px; color: #555; margin-top: 2px; font-style: italic; line-height: 1.2; min-height: 12px; }

        #record-btn { margin-top: 12px; padding: 10px; border: none; border-radius: 50%; background: #0073aa; cursor: pointer; }
        #record-btn img { width: 28px; height: 28px;}

        #record-btn.recording img {
            filter: invert(29%) sepia(93%) saturate(7486%) hue-rotate(356deg) brightness(97%) contrast(116%);
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.6; }
            100% { transform: scale(1); opacity: 1; }
        }

        #close-popup { margin-top: 10px; background: none; border: none; color: #888; cursor: pointer; }

        /* CSS CHO √î K·∫æT QU·∫¢ */
        #result-box { 
            margin-top: 15px; 
            font-size: 15px; 
            color: #222; 
            min-height: 40px; 
            text-align: left; 
            background: #fff; 
            padding: 10px; 
            border-radius: 6px; 
            border: 1px solid #ddd; 
            max-height: 150px; 
            overflow-y: auto; 
            cursor: default;
            position: relative;
            transition: all 0.2s;
        }

        #result-box.clickable {
            cursor: pointer;
            border-color: #28a745;
            background-color: #f9fff9;
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.15);
        }
        #result-box.clickable:hover {
            background-color: #eafbea;
        }
        
        #result-box.clickable::after {
            content: "üëÜ Nh·∫•n v√†o ƒë√¢y ƒë·ªÉ t√¨m ki·∫øm";
            display: block;
            width: 100%;
            text-align: center;
            font-size: 11px;
            color: #28a745;
            margin-top: 8px;
            font-weight: 500;
            border-top: 1px dashed #c3e6cb;
            padding-top: 4px;
        }
        
        .final-text { color: #000; font-weight: bold; }
        .interim-text { color: #888; font-style: italic; }
    </style>

    <button id="voice-search-btn" title="T√¨m ki·∫øm b·∫±ng gi·ªçng n√≥i">
        <img src="https://tiengtrungquoc.net/wp-content/uploads/2025/12/microphone.png" alt="Voice Search">
    </button>

    <div id="voice-popup">
        <h3>Ch·ªçn ng√¥n ng·ªØ</h3>
        <div class="lang-container">
            <button class="lang-btn active" data-lang="vi-VN">
                <img src="https://flagcdn.com/vn.svg" alt="Ti·∫øng Vi·ªát">
                <div class="lang-label">T√¨m b√†i vi·∫øt</div>
                <div class="lang-note">V√≠ d·ª•: ng·ªØ ph√°p HSK 4...</div>
            </button>
            <button class="lang-btn" data-lang="zh-CN">
                <img src="https://flagcdn.com/cn.svg" alt="‰∏≠Êñá">
                <div class="lang-label">Tra t·ª´</div>
                <div class="lang-note">&nbsp;</div>
            </button>
        </div>
        
        <button id="record-btn" title="Ghi √¢m">
            <img src="https://img.icons8.com/ios-glyphs/60/ffffff/microphone.png" alt="Record">
        </button>
        
        <div id="result-box"><span style="color:#aaa;">ƒêang l·∫Øng nghe...</span></div>
        
        <button id="close-popup">ƒê√≥ng</button>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const speechKey = "<?php echo esc_js($speech_key); ?>";
        const serviceRegion = "<?php echo esc_js($speech_region); ?>";

        const popup = document.getElementById('voice-popup');
        const voiceBtn = document.getElementById('voice-search-btn');
        const recordBtn = document.getElementById('record-btn');
        const langBtns = document.querySelectorAll('.lang-btn');
        const closeBtn = document.getElementById('close-popup');
        const resultBox = document.getElementById('result-box');
        const voicePopup = document.getElementById('voice-popup');

        if (voicePopup) document.body.appendChild(voicePopup);

        let selectedLang = "vi-VN";
        let recognizer;
        let isRecording = false;
        let fullText = "";
        let silenceTimer; 

        // --- C·∫¨P NH·∫¨T: H√ÄM L√ÄM S·∫†CH V√Ä B·ªé D·∫§U C√ÇU ---
        function cleanGarbageText(text) {
            if (!text) return "";
            
            // 1. X√≥a c√°c t·ª´ ·∫£o gi√°c (Hallucination)
            let cleaned = text.replace(/(^|\s)(Ph·∫©y|Ph·∫´y|Ch·∫•m|H·ªèi ch·∫•m)(\s|[.,]|$)/gi, " ");
            
            // 2. X√≥a to√†n b·ªô k√Ω t·ª± d·∫•u c√¢u ƒë·∫∑c bi·ªát (Punctuation)
            // Regex x√≥a: . , / # ! $ % ^ & * ; : { } = - _ ` ~ ( ) ?
            cleaned = cleaned.replace(/[.,\/#!$%\^&\*;:{}=\-_`~()?]/g,"");
            
            // 3. X√≥a kho·∫£ng tr·∫Øng th·ª´a
            return cleaned.replace(/\s{2,}/g," ").trim();
        }

        voiceBtn.onclick = (e) => {
            e.stopPropagation(); 
            popup.classList.add('active');
            if (!isRecording) {
                startRecording();
            }
        };

        document.addEventListener('click', (event) => {
            if (popup.classList.contains('active')) {
                if (!popup.contains(event.target) && !voiceBtn.contains(event.target)) {
                    stopRecording();
                }
            }
        });

        popup.onclick = (e) => {
            e.stopPropagation();
        };

        closeBtn.onclick = () => stopRecording(); 

        langBtns.forEach(btn => {
            btn.onclick = () => {
                if(isRecording) return;
                langBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                selectedLang = btn.dataset.lang;
            };
        });

        recordBtn.onclick = () => {
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        };

        function triggerSearch() {
            if (!fullText.trim()) return;

            if (isRecording && recognizer) {
                recognizer.stopContinuousRecognitionAsync();
                isRecording = false;
            }

            const searchInput = document.querySelector('input[name="s"]');
            
            // L√†m s·∫°ch l·∫ßn cu·ªëi cho ch·∫Øc ch·∫Øn
            let cleanText = cleanGarbageText(fullText);

            if(searchInput && searchInput.form){
                searchInput.value = cleanText; 
                searchInput.form.submit();
            } else {
                window.location.href = "<?php echo home_url('/?s='); ?>" + encodeURIComponent(cleanText);
            }
            popup.classList.remove('active');
        }

        resultBox.onclick = () => {
            if (fullText.trim().length > 0) {
                triggerSearch();
            }
        };
        
        function resetUI() {
            resultBox.innerHTML = '<span style="color:#aaa;">ƒêang l·∫Øng nghe...</span>';
            resultBox.classList.remove('clickable');
            fullText = "";
        }

        function resetSilenceTimer() {
            if (silenceTimer) clearTimeout(silenceTimer);
            silenceTimer = setTimeout(() => {
                if (isRecording) {
                    stopRecording();
                    let checkText = cleanGarbageText(fullText);
                    if (checkText.length === 0) {
                         resultBox.innerHTML = '<span style="color:#aaa;">(Kh√¥ng nghe th·∫•y g√¨...)</span>';
                         resultBox.classList.remove('clickable');
                    }
                }
            }, 3000); 
        }

        function startRecording() {
            resetUI();
            
            const speechConfig = SpeechSDK.SpeechConfig.fromSubscription(speechKey, serviceRegion);
            speechConfig.speechRecognitionLanguage = selectedLang;
            
            const audioConfig = SpeechSDK.AudioConfig.fromDefaultMicrophoneInput();
            recognizer = new SpeechSDK.SpeechRecognizer(speechConfig, audioConfig);

            resetSilenceTimer();

            recognizer.recognizing = (s, e) => {
                let tempText = cleanGarbageText(e.result.text);
                // Hi·ªÉn th·ªã text t·∫°m th·ªùi (n·∫øu c√≥ n·ªôi dung sau khi l·ªçc d·∫•u)
                if(tempText) {
                    resultBox.innerHTML = `<span class="interim-text">${tempText}</span>`;
                }
                resetSilenceTimer(); 
            };

            recognizer.recognized = (s, e) => {
                if (e.result.reason === SpeechSDK.ResultReason.RecognizedSpeech) {
                    
                    // L·ªåC S·∫†CH D·∫§U C√ÇU NGAY T·∫†I ƒê√ÇY
                    let validText = cleanGarbageText(e.result.text);
                    
                    if (validText.length > 0) {
                        fullText = validText; 
                        resultBox.innerHTML = `<span class="final-text">${fullText}</span>`;
                        resultBox.classList.add('clickable');
                    }

                    resetSilenceTimer(); 

                } else if (e.result.reason === SpeechSDK.ResultReason.NoMatch) {
                    console.log("NOMATCH");
                }
            };

            recognizer.canceled = (s, e) => {
                stopRecording();
                resultBox.innerHTML += `<div style="color:red; font-size:12px;">ƒê√£ ng·∫Øt k·∫øt n·ªëi.</div>`;
            };

            recognizer.sessionStopped = (s, e) => {
                stopRecording();
            };

            recognizer.startContinuousRecognitionAsync(() => {
                isRecording = true;
                recordBtn.classList.add("recording");
            }, (err) => {
                resultBox.innerHTML = "L·ªói: " + err;
                isRecording = false;
            });
        }

        function stopRecording() {
            if (silenceTimer) clearTimeout(silenceTimer);

            if (!isRecording) {
                popup.classList.remove('active');
                return;
            }
            if (recognizer) {
                recognizer.stopContinuousRecognitionAsync(() => {
                    isRecording = false;
                    recordBtn.classList.remove("recording");
                    
                    if(cleanGarbageText(fullText).length > 0) {
                        resultBox.classList.add('clickable');
                    }
                });
            }
        }
    });
    </script>
    <?php
    return ob_get_clean();
});

// ===================================================================================
// PH·∫¶N 3: T√åM KI·∫æM TRONG TI√äU ƒê·ªÄ
// ===================================================================================

function __custom_search_by_title_smart_v89( $search, $wp_query ) {
    global $wpdb;
    if ( ! is_admin() && $wp_query->is_main_query() && $wp_query->is_search() ) {
        $search_term = $wp_query->query_vars['s'];
        if ( empty( $search_term ) ) return $search;
        $search_terms = explode( ' ', $search_term );
        $search_conditions = [];
        foreach ( $search_terms as $term ) {
            $term = trim( $term );
            if ( !empty($term) ) {
                $search_conditions[] = $wpdb->prepare("{$wpdb->posts}.post_title LIKE %s", '%' . $wpdb->esc_like( $term ) . '%');
            }
        }
        if ( !empty($search_conditions) ) {
            $search = " AND ( " . implode( ' AND ', $search_conditions ) . " )";
            $search .= " AND ({$wpdb->posts}.post_status = 'publish')";
        }
    }
    return $search;
}
add_filter( 'posts_search', '__custom_search_by_title_smart_v89', 10, 2 );
