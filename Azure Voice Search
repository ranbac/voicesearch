/*
 * Plugin Name: Azure Voice Search (Chinese Punctuation Fix)
 * Description: T√¨m ki·∫øm gi·ªçng n√≥i. ƒê√£ l·ªçc b·ªè d·∫•u c√¢u ti·∫øng Trung („ÄÇÔºüÔºÅÔºå).
 * Version: 8.5
 * Author: Strong Anchor Tech (Updated by Gemini)
 * Author URI: https://stronganchortech.com
 */

// ===================================================================================
// PH·∫¶N 1: C√ÄI ƒê·∫∂T & C·∫§U H√åNH AZURE
// ===================================================================================

add_action('admin_menu', function() {
    add_submenu_page('tools.php', 'Azure Speech Settings', 'Azure Speech', 'manage_options', 'azure-speech-settings', function() {
        ?>
        <div class="wrap">
            <h2>Azure Cognitive Services Speech - C√†i ƒë·∫∑t</h2>
            <form method="post" action="options.php">
                <?php
                    settings_fields('azure_speech_settings_group');
                    do_settings_sections('azure_speech_settings_group');
                ?>
                <table class="form-table">
                    <tr valign="top">
                        <th scope="row">Azure Speech Key</th>
                        <td><input type="text" name="azure_speech_key" value="<?php echo esc_attr(get_option('azure_speech_key')); ?>" size="60" /></td>
                    </tr>
                    <tr valign="top">
                        <th scope="row">Azure Speech Region</th>
                        <td><input type="text" name="azure_speech_region" value="<?php echo esc_attr(get_option('azure_speech_region')); ?>" size="20" placeholder="eastus, southeastasia" /></td>
                    </tr>
                </table>
                <?php submit_button(); ?>
            </form>
        </div>
        <?php
    });
});

add_action('admin_init', function() {
    register_setting('azure_speech_settings_group', 'azure_speech_key');
    register_setting('azure_speech_settings_group', 'azure_speech_region');
});

// ===================================================================================
// PH·∫¶N 2: API L·∫§Y TOKEN (BACKEND)
// ===================================================================================

add_action('wp_ajax_azure_get_token', 'azure_get_token_callback');
add_action('wp_ajax_nopriv_azure_get_token', 'azure_get_token_callback');

function azure_get_token_callback() {
    $speech_key = get_option('azure_speech_key');
    $speech_region = get_option('azure_speech_region');

    if (!$speech_key || !$speech_region) {
        wp_send_json_error('Ch∆∞a c·∫•u h√¨nh API Key/Region.');
    }

    $url = "https://{$speech_region}.api.cognitive.microsoft.com/sts/v1.0/issueToken";

    $ch = curl_init($url);
    curl_setopt($ch, CURLOPT_POST, true);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_HTTPHEADER, array(
        'Ocp-Apim-Subscription-Key: ' . $speech_key,
        'Content-Length: 0'
    ));

    $token = curl_exec($ch);
    $http_code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    curl_close($ch);

    if ($http_code != 200 || !$token) {
        wp_send_json_error("L·ªói l·∫•y Token t·ª´ Azure (HTTP $http_code)");
    }

    wp_send_json_success([
        'token' => $token,
        'region' => $speech_region
    ]);
}

// ===================================================================================
// PH·∫¶N 3: SHORTCODE & GIAO DI·ªÜN (FRONTEND)
// ===================================================================================

add_shortcode('voice_search_button', function() {
    wp_enqueue_script('azure-speech-sdk', 'https://aka.ms/csspeech/jsbrowserpackageraw', [], null, true);
    
    ob_start();
    ?>
    <style>
        /* --- N√∫t k√≠ch ho·∫°t --- */
        #voice-search-btn { background: none; border: none; cursor: pointer; padding: 5px; }
        #voice-search-btn img { width: 28px; height: 28px; }

        /* --- Overlay trong su·ªët --- */
        #voice-overlay {
            display: none; 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: transparent; 
            z-index: 99998; 
        }
        #voice-overlay.active { display: block; }

        /* --- Popup ch√≠nh --- */
        #voice-popup {
            display: none; position: fixed; 
            top: 50% !important; left: 50% !important;
            transform: translate(-50%, -50%) !important;
            background: #fff !important; padding: 30px 20px 20px 20px; 
            border-radius: 12px;
            border: 1px solid #e0e0e0; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.15); 
            text-align: center; 
            z-index: 99999;
            width: 340px;
            max-width: 90%;
        }
        #voice-popup.active { display: block; }
        #voice-popup h3 { margin-top: 0; font-size: 18px; margin-bottom: 15px; color: #333; }

        /* --- N√∫t X ƒê√≥ng --- */
        #close-popup-x {
            position: absolute; top: 8px; right: 12px;
            background: none; border: none; font-size: 24px;
            color: #aaa; cursor: pointer; line-height: 1; padding: 0;
        }
        #close-popup-x:hover { color: #d63638; }

        /* --- CSS N√öT C·ªú --- */
        .lang-container { display: flex; justify-content: center; gap: 14px; margin-bottom: 12px; }
        .lang-btn { border: none; background: none; cursor: pointer; text-align: center; padding: 5px; }
        
        /* M·∫∑c ƒë·ªãnh: X√°m v√† m·ªù */
        .lang-btn img { 
            width: 48px; height: 32px; 
            border-radius: 4px; 
            transition: all 0.3s ease; 
            filter: grayscale(100%);   
            opacity: 0.5;              
        }

        /* ƒêang ch·ªçn: Nguy√™n b·∫£n */
        .lang-btn.active img { 
            filter: none;       
            opacity: 1;         
            transform: none;    
            box-shadow: 0 4px 10px rgba(0,0,0,0.15); 
        }

        /* Hover */
        .lang-btn:hover img {
            filter: grayscale(0%);
            opacity: 0.9;
        }

        .lang-label { font-size: 12px; margin-top: 4px; color: #333; font-weight: 600; }
        .lang-note { font-size: 10px; color: #666; margin-top: 2px; font-style: italic; }


        /* --- N√∫t Record --- */
        #record-btn { margin-top: 15px; padding: 12px; border: none; border-radius: 50%; background: #0073aa; cursor: pointer; transition: all 0.3s; }
        #record-btn img { width: 32px; height: 32px; vertical-align: middle; }
        
        #record-btn.listening {
            background: #d63638;
            box-shadow: 0 0 0 0 rgba(214, 54, 56, 0.7);
            animation: pulse-red 1.5s infinite;
        }
        @keyframes pulse-red {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(214, 54, 56, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 15px rgba(214, 54, 56, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(214, 54, 56, 0); }
        }

        /* --- K·∫øt qu·∫£ --- */
        #result-box { margin-top: 20px; font-size: 16px; color: #222; min-height: 24px; font-weight: 500; }
        
        .result-final-link { 
            color: #0073aa; font-weight: bold; font-size: 18px;
            text-decoration: none; cursor: pointer; padding: 8px 15px;
            display: inline-block; transition: 0.2s;
            border: 1px dashed #0073aa; border-radius: 20px;
            background: rgba(0, 115, 170, 0.08);
        }
        .result-final-link:hover { background: #0073aa; color: #fff; }
        .result-interim { color: #999; font-style: italic; }
    </style>

    <button id="voice-search-btn" type="button" title="T√¨m ki·∫øm b·∫±ng gi·ªçng n√≥i">
        <img src="https://tiengtrungquoc.net/wp-content/uploads/2025/12/microphone.png" alt="Voice Search">
    </button>

    <div id="voice-overlay"></div>

    <div id="voice-popup">
        <button id="close-popup-x" type="button" title="ƒê√≥ng">&times;</button>

        <h3>Ch·ªçn ng√¥n ng·ªØ</h3>
        
        <div class="lang-container">
            <button class="lang-btn active" data-lang="vi-VN">
                <img src="https://flagcdn.com/vn.svg" alt="Ti·∫øng Vi·ªát">
                <div class="lang-label">T√¨m b√†i vi·∫øt, tra t·ª´, d·ªãch c√¢u</div>
                <div class="lang-note">"Ng·ªØ ph√°p HSK 4..."</div>
            </button>
            <button class="lang-btn" data-lang="zh-CN">
                <img src="https://flagcdn.com/cn.svg" alt="‰∏≠Êñá">
                <div class="lang-label">Tra t·ª´, d·ªãch c√¢u</div>
                <div class="lang-note">"‰Ω†Â•Ω..."</div>
            </button>
        </div>

        <button id="record-btn" type="button" title="B·∫•m ƒë·ªÉ n√≥i ngay">
            <img src="https://img.icons8.com/ios-glyphs/60/ffffff/microphone.png" alt="Record">
        </button>

        <div id="result-box">B·∫•m micro ·ªü tr√™n ƒë·ªÉ n√≥i...</div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const popup = document.getElementById('voice-popup');
        const overlay = document.getElementById('voice-overlay');
        const voiceBtn = document.getElementById('voice-search-btn');
        const recordBtn = document.getElementById('record-btn');
        const langBtns = document.querySelectorAll('.lang-btn');
        const closeBtnX = document.getElementById('close-popup-x'); 
        const resultBox = document.getElementById('result-box');

        let selectedLang = "vi-VN";
        let recognizer;
        let isListening = false;
        let cachedTokenObj = null; 

        if (document.getElementById('voice-popup')) {
            document.body.appendChild(overlay);
            document.body.appendChild(popup);
        }

        // --- S·ª∞ KI·ªÜN: M·ªû POPUP ---
        voiceBtn.onclick = () => {
            popup.classList.add('active');
            overlay.classList.add('active'); 
            prepareTokenInBackground(); 
        };

        // --- S·ª∞ KI·ªÜN: ƒê√ìNG POPUP ---
        const closeAll = () => stopRecognition(true);
        
        closeBtnX.onclick = closeAll; 
        overlay.onclick = closeAll;   

        langBtns.forEach(btn => {
            btn.onclick = () => {
                langBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                selectedLang = btn.dataset.lang;
            };
        });

        async function prepareTokenInBackground() {
            if (cachedTokenObj && (Date.now() - cachedTokenObj.time < 540000)) {
                return; 
            }
            try {
                const formData = new FormData();
                formData.append('action', 'azure_get_token');
                
                const response = await fetch("<?php echo admin_url('admin-ajax.php'); ?>", {
                    method: 'POST', body: formData
                });
                const data = await response.json();

                if (data.success) {
                    cachedTokenObj = {
                        token: data.data.token,
                        region: data.data.region,
                        time: Date.now()
                    };
                    console.log("Azure Token ƒë√£ s·∫µn s√†ng!");
                }
            } catch (e) {
                console.error("L·ªói l·∫•y token ng·∫ßm:", e);
            }
        }

        recordBtn.onclick = () => {
            if (isListening) {
                stopRecognition(false);
            } else {
                startRecognition();
            }
        };

        async function startRecognition() {
            if (!cachedTokenObj) {
                resultBox.innerHTML = "‚è≥ ƒêang k·∫øt n·ªëi server...";
                await prepareTokenInBackground();
            }

            if (!cachedTokenObj) {
                resultBox.innerHTML = "‚ùå L·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i.";
                return;
            }

            try {
                const speechConfig = SpeechSDK.SpeechConfig.fromAuthorizationToken(cachedTokenObj.token, cachedTokenObj.region);
                speechConfig.speechRecognitionLanguage = selectedLang;
                
                const audioConfig = SpeechSDK.AudioConfig.fromDefaultMicrophoneInput();
                recognizer = new SpeechSDK.SpeechRecognizer(speechConfig, audioConfig);

                recognizer.recognizing = (s, e) => {
                    resultBox.innerHTML = `<span class="result-interim">${e.result.text}</span>`;
                };

                // --- X·ª¨ L√ù K·∫æT QU·∫¢ ---
                recognizer.recognized = (s, e) => {
                    if (e.result.reason === SpeechSDK.ResultReason.RecognizedSpeech) {
                        // C·∫¨P NH·∫¨T: REGEX B·ªé D·∫§U C√ÇU C·∫¢ TI·∫æNG VI·ªÜT V√Ä TRUNG
                        // .,?! : Ti·∫øng Vi·ªát/Anh
                        // „ÄÇÔºåÔºüÔºÅ„ÄÅ: Ti·∫øng Trung
                        const finalText = e.result.text.replace(/[.,?!:;„ÄÇÔºåÔºüÔºÅ„ÄÅ]/g, '');
                        
                        resultBox.innerHTML = '';
                        const link = document.createElement('a');
                        link.className = 'result-final-link';
                        link.innerText = finalText;
                        link.title = "B·∫•m ƒë·ªÉ t√¨m ki·∫øm ngay: " + finalText;
                        link.onclick = (event) => {
                            event.preventDefault();
                            performSearch(finalText);
                        };
                        resultBox.appendChild(link);
                        
                        stopRecognition(false);
                    } else if (e.result.reason === SpeechSDK.ResultReason.NoMatch) {
                        resultBox.innerHTML = "‚ùå Kh√¥ng nghe r√µ. Th·ª≠ l·∫°i nh√©!";
                        stopRecognition(false);
                    }
                };

                recognizer.canceled = (s, e) => {
                    resultBox.innerHTML = "‚ùå ƒê√£ d·ª´ng.";
                    stopRecognition(false);
                };

                recognizer.sessionStopped = (s, e) => {
                    stopRecognition(false);
                };

                recognizer.startContinuousRecognitionAsync();
                
                isListening = true;
                recordBtn.classList.add('listening');
                resultBox.innerHTML = "üé§ ƒêang l·∫Øng nghe...";

            } catch (err) {
                console.error(err);
                resultBox.innerHTML = "‚ùå Kh√¥ng t√¨m th·∫•y Micro.";
            }
        }

        function stopRecognition(closePopup) {
            if (recognizer) {
                recognizer.stopContinuousRecognitionAsync(() => {
                    recognizer.close();
                    recognizer = undefined;
                });
            }
            isListening = false;
            recordBtn.classList.remove('listening');
            
            if (closePopup) {
                popup.classList.remove('active');
                overlay.classList.remove('active');
                resultBox.innerHTML = "B·∫•m micro ·ªü tr√™n ƒë·ªÉ n√≥i...";
            }
        }

        function performSearch(query) {
            resultBox.innerHTML = "üöÄ ƒêang t√¨m ki·∫øm: " + query + "...";
            const searchInput = document.querySelector('input[name="s"]');
            if(searchInput && searchInput.form){
                searchInput.value = query;
                searchInput.form.submit();
            } else {
                window.location.href = "<?php echo home_url('/?s='); ?>" + encodeURIComponent(query);
            }
        }
    });
    </script>
    <?php
    return ob_get_clean();
});

// ===================================================================================
// PH·∫¶N 4: B·ªò L·ªåC T√åM KI·∫æM
// ===================================================================================

function __custom_search_by_title_only( $search, $wp_query ) {
    global $wpdb;
    if ( ! is_admin() && $wp_query->is_main_query() && $wp_query->is_search() ) {
        $search_term = $wp_query->query_vars['s'];
        if ( empty( $search_term ) ) return $search;

        $search_terms = explode( ' ', $search_term );
        $search_conditions = [];

        foreach ( $search_terms as $term ) {
            $term = trim( $term );
            if ( !empty($term) ) {
                $search_conditions[] = $wpdb->prepare("{$wpdb->posts}.post_title LIKE %s", '%' . $wpdb->esc_like( $term ) . '%');
            }
        }

        if ( !empty($search_conditions) ) {
            $search = " AND ( " . implode( ' AND ', $search_conditions ) . " )";
            $search .= " AND ({$wpdb->posts}.post_status = 'publish')";
        }
    }
    return $search;
}
add_filter( 'posts_search', '__custom_search_by_title_only', 10, 2 );
